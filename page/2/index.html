<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Code And Coffee</title>
  <meta name="keywords" content="undefined,undefined">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="java | 后端 | 经验 | blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Code And Coffee">
<meta property="og:url" content="https://codeandcoffee.cn/page/2/index.html">
<meta property="og:site_name" content="Code And Coffee">
<meta property="og:description" content="java | 后端 | 经验 | blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code And Coffee">
<meta name="twitter:description" content="java | 后端 | 经验 | blog">
  
  
  
    <link rel="icon" href="https://codeandcoffee.cn/icon.png">
  
  
    <link href="https://codeandcoffee.cn/css.css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Code And Coffee</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">little thing stoppin</a><br/><br/>
          <a href="https://github.com/liuxinsi" target="_blank"><image src="https://codeandcoffee.cn/fluidicon.png" width="2%" height="2%"/></a>&nbsp;
          <a href="https://codeandcoffee.cn/resume.html" target="_blank"><image src="https://codeandcoffee.cn/handshake.png"  width="2%" height="2%"/></a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://codeandcoffee.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-mongodb-orm-morphia-cache-issue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/02/mongodb-orm-morphia-cache-issue/" class="article-date">
  <time datetime="2017-11-02T06:59:43.000Z" itemprop="datePublished">2017-11-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/02/mongodb-orm-morphia-cache-issue/">MongoDB ORM框架Morphia缓存小坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在用Morphia更新MongoDB数据时发现更新完后没有拿到更新后的新数据，一开始没有在意以为MongDB复制集读写分离后拿的从服务器数据，从服务器还没有同步到更新。后来一想不太对，复制集的op同步的间隔很短，更新和查询又是在一个上下文中，而且当时读写相当空闲，虽然NOSQL都是保证最终一致性，但如果这么简单的一个操作都没办法保证原子性那也太搓了，而且用MongoDB这么多年也没发现类似的问题。</p>
<p>重现代码：<br><figure class="highlight plain"><figcaption><span>Test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test() &#123;</span><br><span class="line">    Query&lt;Blog&gt; q = datastore.createQuery(Blog.class).field(&quot;author&quot;).equal(&quot;b&quot;);</span><br><span class="line">    System.out.println(q.get());</span><br><span class="line"></span><br><span class="line">    Query&lt;Blog&gt; ctQ = datastore.createQuery(Blog.class);</span><br><span class="line">    ctQ.field(&quot;author&quot;).equal(&quot;b&quot;);</span><br><span class="line">    UpdateOperations&lt;Blog&gt; u = datastore.createUpdateOperations(Blog.class);</span><br><span class="line">    u.set(&quot;post&quot;, &quot;zzzz&quot;);</span><br><span class="line">    datastore.update(ctQ, u);</span><br><span class="line">    </span><br><span class="line">    System.out.println(q.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行一下查询，然后在更新，在查询。根据日志显示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#####第一次执行查询，post是1111111</span><br><span class="line">Creating MappedClass for class mongo.service.Blog</span><br><span class="line">[TRACE] 2017-11-02 09:21:00,506 [main] [org.mongodb.morphia.query.QueryImpl] - Running query(Blog) : &#123; &quot;author&quot; : &quot;b&quot;&#125;, fields:null,off:0,limit:1</span><br><span class="line">[TRACE] 2017-11-02 09:21:00,506 [main] [org.mongodb.morphia.query.QueryImpl] - Getting cursor(Blog)  for query:&#123; &quot;author&quot; : &quot;b&quot;&#125;</span><br><span class="line">[DEBUG] 2017-11-02 09:21:00,506 [main] [org.mongodb.driver.protocol.command] - Sending command &#123;find : BsonString&#123;value=&apos;Blog&apos;&#125;&#125; to database PTMO_TEST on connection [connectionId&#123;localValue:2, serverValue:7577&#125;] to server 26.47.136.186:57004</span><br><span class="line">[DEBUG] 2017-11-02 09:21:00,508 [main] [org.mongodb.driver.protocol.command] - Command execution completed</span><br><span class="line">Blog(_id=59fa6b4b934f0741cd03663e, author=b, post=1111111, comments=null)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">####### 执行更新，更新post为zzzz</span><br><span class="line">[TRACE] 2017-11-02 09:21:00,513 [main] [org.mongodb.morphia.DatastoreImpl] - Executing update(Blog) for query: &#123; &quot;author&quot; : &quot;b&quot;&#125;, ops: &#123; &quot;$set&quot; : &#123; &quot;post&quot; : &quot;zzzz&quot;&#125;&#125;, multi: true, upsert: false</span><br><span class="line">[DEBUG] 2017-11-02 09:21:00,520 [main] [org.mongodb.driver.protocol.update] - Updating documents in namespace PTMO_TEST.Blog on connection [connectionId&#123;localValue:2, serverValue:7577&#125;] to server 26.47.136.186:57004</span><br><span class="line">[DEBUG] 2017-11-02 09:21:00,529 [main] [org.mongodb.driver.protocol.update] - Update completed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">######第二次执行查询，查询出来的对象post仍然是1111111</span><br><span class="line">[TRACE] 2017-11-02 09:21:00,531 [main] [org.mongodb.morphia.query.QueryImpl] - Running query(Blog) : &#123; &quot;author&quot; : &quot;b&quot;&#125;, fields:null,off:0,limit:1</span><br><span class="line">[TRACE] 2017-11-02 09:21:00,531 [main] [org.mongodb.morphia.query.QueryImpl] - Getting cursor(Blog)  for query:&#123; &quot;author&quot; : &quot;b&quot;&#125;</span><br><span class="line">[DEBUG] 2017-11-02 09:21:00,532 [main] [org.mongodb.driver.protocol.command] - Sending command &#123;find : BsonString&#123;value=&apos;Blog&apos;&#125;&#125; to database PTMO_TEST on connection [connectionId&#123;localValue:2, serverValue:7577&#125;] to server 26.47.136.186:57004</span><br><span class="line">Blog(_id=59fa6b4b934f0741cd03663e, author=b, post=1111111, comments=null)</span><br></pre></td></tr></table></figure></p>
<p>就是这迷惑性的日志，让我觉得每次 q.get()就是向数据库进行查询操作。<br>我一开始以为是数据没有落实所以读到是老数据，于是修改update时 WriteConcern进行更新。</p>
<figure class="highlight plain"><figcaption><span>Test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datastore.update(ctQ,u, false, WriteConcern.JOURNALED);</span><br></pre></td></tr></table></figure>
<ul>
<li>JOURNALED:        确保数据到磁盘上的事务日志中才返回。</li>
<li>MAJORITY:         大多数数据节点确认后才返回。</li>
<li>ACKNOWLEDGED:     默认机制，服务器收到就返回。</li>
<li>UNACKNOWLEDGED:   socket write后没报异常就返回。</li>
<li>W1/W2/W3:         1/2/3个成员确认后才返回。</li>
</ul>
<p>然而仍然没什么用，不是数据落实问题。后来想到MongoDB中原子性的更新是 findAndModify ,于是改成findAndModify：<br><figure class="highlight plain"><figcaption><span>Test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//      datastore.update(ctQ, u);</span><br><span class="line">        Blog b = datastore.findAndModify(ctQ, u);</span><br><span class="line">        System.out.println(b);</span><br></pre></td></tr></table></figure><br>执行后确实拿到了最新的数据，虽然问题可以换成FAM解决但仍然想知道问题的原因，于是跟了一下get()的源码。</p>
<p>Query get的实现类 QueryImpl：<br><figure class="highlight plain"><figcaption><span>QueryImpl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public T get() &#123;</span><br><span class="line">    final int oldLimit = limit;</span><br><span class="line">    limit = 1;</span><br><span class="line">    final Iterator&lt;T&gt; it = fetch().iterator();</span><br><span class="line">    limit = oldLimit;</span><br><span class="line">    return (it.hasNext()) ? it.next() : null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际上是fetch方法执行的查询<br><figure class="highlight plain"><figcaption><span>QueryImpl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public MorphiaIterator&lt;T, T&gt; fetch() &#123;</span><br><span class="line">    final DBCursor cursor = prepareCursor();</span><br><span class="line">    if (LOG.isTraceEnabled()) &#123;</span><br><span class="line">        LOG.trace(&quot;Getting cursor(&quot; + dbColl.getName() + &quot;)  for query:&quot; + cursor.getQuery());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return new MorphiaIterator&lt;T, T&gt;(ds, cursor, ds.getMapper(), clazz, dbColl.getName(), cache);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在prepareCursor()方法中，确实可以看到框架封装了DBObject以及DBCollection，并确确实实的调用了find方法进行查询：<br><figure class="highlight plain"><figcaption><span>QueryImpl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Prepares cursor for iteration</span><br><span class="line"> *</span><br><span class="line"> * @return the cursor</span><br><span class="line"> */</span><br><span class="line">public DBCursor prepareCursor() &#123;</span><br><span class="line">    final DBObject query = getQueryObject();</span><br><span class="line">    final DBObject fields = getFieldsObject();</span><br><span class="line"></span><br><span class="line">    if (LOG.isTraceEnabled()) &#123;</span><br><span class="line">        LOG.trace(&quot;Running query(&quot; + dbColl.getName() + &quot;) : &quot; + query + &quot;, fields:&quot; + fields + &quot;,off:&quot; + offset + &quot;,limit:&quot; + limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final DBCursor cursor = dbColl.find(query, fields);</span><br><span class="line">    cursor.setDecoderFactory(ds.getDecoderFact());</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>但是返回的cursor封装到了MorphiaIterator里，并且传参跟随着一个cache。<br>MorphiaIterator也是Iterator的实现，其中封装next操作，在获取到DBOBject进行反序列化操作，具体反序列化操作调用的Mapper类中的方法：<br><figure class="highlight plain"><figcaption><span>Mapper</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Converts a DBObject back to a type-safe java object (POJO)</span><br><span class="line"> *</span><br><span class="line"> * @param &lt;T&gt;       the type of the entity</span><br><span class="line"> * @param datastore the Datastore to use when fetching this reference</span><br><span class="line"> * @param dbObject  the DBObject containing the document from mongodb</span><br><span class="line"> * @param entity    the instance to populate</span><br><span class="line"> * @param cache     the EntityCache to use</span><br><span class="line"> * @return the entity</span><br><span class="line"> */</span><br><span class="line">public &lt;T&gt; T fromDb(final Datastore datastore, final DBObject dbObject, final T entity, final EntityCache cache) &#123;</span><br><span class="line">    //hack to bypass things and just read the value.</span><br><span class="line">    if (entity instanceof MappedField) &#123;</span><br><span class="line">        readMappedField(datastore, (MappedField) entity, entity, cache, dbObject);</span><br><span class="line">        return entity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // check the history key (a key is the namespace + id)</span><br><span class="line"></span><br><span class="line">    if (dbObject.containsField(ID_KEY) &amp;&amp; getMappedClass(entity).getIdField() != null</span><br><span class="line">        &amp;&amp; getMappedClass(entity).getEntityAnnotation() != null) &#123;</span><br><span class="line">        final Key&lt;T&gt; key = new Key(entity.getClass(), getCollectionName(entity.getClass()), dbObject.get(ID_KEY));</span><br><span class="line">        final T cachedInstance = cache.getEntity(key);</span><br><span class="line">        if (cachedInstance != null) &#123;</span><br><span class="line">            return cachedInstance;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            cache.putEntity(key, entity); // to avoid stackOverflow in recursive refs</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final MappedClass mc = getMappedClass(entity);</span><br><span class="line"></span><br><span class="line">    final DBObject updated = mc.callLifecycleMethods(PreLoad.class, entity, dbObject, this);</span><br><span class="line">    try &#123;</span><br><span class="line">        for (final MappedField mf : mc.getPersistenceFields()) &#123;</span><br><span class="line">            readMappedField(datastore, mf, entity, cache, updated);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (final MappingException e) &#123;</span><br><span class="line">        Object id = dbObject.get(ID_KEY);</span><br><span class="line">        String entityName = entity.getClass().getName();</span><br><span class="line">        throw new MappingException(format(&quot;Could not map %s with ID: %s in database &apos;%s&apos;&quot;, entityName, id,</span><br><span class="line">                                          datastore.getDB().getName()), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (updated.containsField(ID_KEY) &amp;&amp; getMappedClass(entity).getIdField() != null) &#123;</span><br><span class="line">        final Key key = new Key(entity.getClass(), getCollectionName(entity.getClass()), updated.get(ID_KEY));</span><br><span class="line">        cache.putEntity(key, entity);</span><br><span class="line">    &#125;</span><br><span class="line">    mc.callLifecycleMethods(PostLoad.class, entity, updated, this);</span><br><span class="line">    return entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到22行-28行是有缓存操作的，缓存的key是集合名和_id值，也就是说虽然第二个get确实执行了查询操作，但由于_id一样所以Morphia直接获取了cachedInstance操作，导致拿到的是第一次的缓存结果。<br>根据cache的注释来看，在同一个query对象的查询返回的都是缓存。<br>所以后续的查询其实有一部分是为了获取_id值用于拼cache key的，如果命中就取缓存。<br>比较坑的是如果有多次查询，并且查询结果比较大，后续的查询其实是浪费，这种缓存机制应该交给开发者进行控制，还能省一些查询。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/11/02/mongodb-orm-morphia-cache-issue/" data-id="ckpl281t40016v6sezncstqv0" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/11/02/mongodb-orm-morphia-cache-issue/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Morphia/">Morphia</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/踩坑/">踩坑</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-tomcat-hangs-on-deploying" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/08/tomcat-hangs-on-deploying/" class="article-date">
  <time datetime="2017-09-08T08:36:02.000Z" itemprop="datePublished">2017-09-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/踩坑/">踩坑</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/08/tomcat-hangs-on-deploying/">Tomcat在部署应用时卡住</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最新在一台新的CentOS上部署环境，当部署完Tomcat8准备启起来看看效果时发现一直阻塞在部署应用这条日志下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Deploying web application directory /tomcat/webapps/live</span><br></pre></td></tr></table></figure></p>
<p>记得新下载的tomcat解压后直接启动一点问题没有，但为了安全清空了webapps下的tomcat ROOT和Manage应用后，并把我的应用传上来在启动就卡住了，一直无解。<br>后来google到了一篇文章<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">One thing I noticed on one of my first upgrades is that TC7 can often</span><br><span class="line">take a long time to start up due to slow initialization of the</span><br><span class="line">SessionIdGenerator - it can take up to nearly 2 minutes!  It appears</span><br><span class="line">to take longer if I restart TC7 quickly which seems to confirm that a</span><br><span class="line">lack of entropy is the issue.</span><br><span class="line"></span><br><span class="line">org.apache.catalina.util.SessionIdGenerator-: Creation of SecureRandom</span><br><span class="line">instance for session ID generation using [SHA1PRNG] took [105,014]</span><br><span class="line">milliseconds.</span><br></pre></td></tr></table></figure></p>
<p>大体意思为Tomcat7+依赖 <strong>SecureRandom</strong> 提供的随机数给分布式Session做ID，取决于JRE，可能会导致Tomcat启动的延迟，上面这个人大概等了2分钟左右。</p>
<p>有两种解决方法.<br>1.修改Tomcat catalina.sh配置，设置非阻塞的SecureRandom初始化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.security.egd=file:/dev/./urandom</span><br></pre></td></tr></table></figure></p>
<p>2.修改JVM配置$JAVA_PATH/jre/lib/security/java.security。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">securerandom.source=file:/dev/urandom</span><br></pre></td></tr></table></figure></p>
<p>替换成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">securerandom.source=file:/dev/./urandom</span><br></pre></td></tr></table></figure></p>
<p>修改后，启动时间恢复正常。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/09/08/tomcat-hangs-on-deploying/" data-id="ckpl281tb001vv6sesigkwc72" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/09/08/tomcat-hangs-on-deploying/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Bug/">Bug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tomcat/">Tomcat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/踩坑/">踩坑</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-share-linux-dir-with-nfs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/09/share-linux-dir-with-nfs/" class="article-date">
  <time datetime="2017-08-09T02:26:00.000Z" itemprop="datePublished">2017-08-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/09/share-linux-dir-with-nfs/">利用NFS进行Linux之间的目录共享</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近需要在linux下共享个目录到另外一台linux下用用，如果有桌面环境用鼠标点点就可以轻松配个samba出来，但服务器版则要改一堆配置才行，太麻烦。后来突然想到如果只是linux之间的共享不涉及到windows其实用NFS就可以，还简单一点。</p>
<p>NFS简单描述：</p>
<blockquote>
<p>NFS是一个sun创建的网络协议，NFS运行在一个区域网直接进行文件共享。etc…</p>
</blockquote>
<p>1.修改/etc/exports文件。</p>
<blockquote>
<p>exports文件用于暴露需要共享的文件给NFS客户端，是一个访问控制列表。</p>
</blockquote>
<p>2.添加要共享的目录到文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/exports</span><br><span class="line">/home/xxx/ttt/ 26.47.136.*(rw,sync,no_root_squash)</span><br></pre></td></tr></table></figure></p>
<p>配置以空格分割。</p>
<ul>
<li>/home/xxx/ttt/ 指要共享的目录。</li>
<li>26.47.136.* 术语叫:Machine Name Formats，理解为客户端的授权方式，这里配置的允许客户端来自26.47这个网段，还支持域名、nis netgroups等方式。</li>
<li>括号里的是配置项<ul>
<li>rw 允许读写</li>
<li>sync 确保文件存储到磁盘后才响应客户端，与之对应的是async。</li>
<li>no_root_squash 使用者如果是root，那么对于这个目录他就有root权限。一般正式环境不建议用这个选项，不安全，与之对应的是root_squash。</li>
</ul>
</li>
</ul>
<p>保存修改后，NFS服务端的配置已经完成。运行脚本启动NFS服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/portmap start</span><br><span class="line">/etc/init.d/nfs start</span><br></pre></td></tr></table></figure></p>
<p>3.另外一台服务器做为客户端挂载共享目录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs 26.47.136.19:/home/xxx/ttt /mnt/xxx</span><br><span class="line">ls /mnt/xxx</span><br></pre></td></tr></table></figure></p>
<p>挂载类型使用nfs，就可以将共享目录挂载到/mnt/xxx下。</p>
<h1 id="出现的问题"><a href="#出现的问题" class="headerlink" title="出现的问题"></a>出现的问题</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed: RPC Error: Program not registered</span><br></pre></td></tr></table></figure>
<p>使用命令查看NFS服务端的服务器进程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep rpc</span><br></pre></td></tr></table></figure></p>
<p>正常应该有两个进程 rpc.statd 和 rpc.mountd，如果没有启动则手动启起来，一般在/usr/sbin下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access deny</span><br></pre></td></tr></table></figure>
<p>检查下iptables，hosts.allow等配置。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/08/09/share-linux-dir-with-nfs/" data-id="ckpl281t6001fv6se1nxddqwo" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/08/09/share-linux-dir-with-nfs/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NFS/">NFS</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-integrate-swagger-with-jersey-springboot" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/03/integrate-swagger-with-jersey-springboot/" class="article-date">
  <time datetime="2017-07-03T12:55:13.000Z" itemprop="datePublished">2017-07-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/微服务/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/03/integrate-swagger-with-jersey-springboot/">在基于Spring-Boot的Jersey中集成Swagger</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近一时兴起，想将最近几年工作中用到的微服务栈，提干，优化一下作为Seed项目记录一下，省着忘了。<br><a href="https://github.com/liuxinsi/my-microservice-seed" target="_blank" rel="noopener">my-microservice-seed</a></p>
<p>本来想引入Swagger来作为Api描述与设计，以前在一个基于Spring REST开发的一个小后台项目中简单的初探过，配置起来很方便。<br>只要引入io.springfox的两个依赖，在提供一个配置类，配置类中在指定下下RestControlle所有在的包既可通过swagger-ui.html看到生成的描述。like this<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author liuxinsi</span><br><span class="line"> * @mail akalxs@gmail.com</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@EnableSwagger2</span><br><span class="line">public class Swagger &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public Docket createRestApi() &#123;</span><br><span class="line">        return new Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(&quot;com.lxs.mms.rs.resource&quot;))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ApiInfo apiInfo() &#123;</span><br><span class="line">        return new ApiInfoBuilder()</span><br><span class="line">                .title(&quot;MMS&quot;)</span><br><span class="line">                .description(&quot;my microservice seed&quot;)</span><br><span class="line">                .version(&quot;1.0.0&quot;)</span><br><span class="line">                .contact(new Contact(&quot;liuxinsi&quot;, &quot;https://liuxinsi.github.io&quot;, &quot;akalxs@gmail.com&quot;))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但这次试用的是Jersey，配置后没办法产生文档，根据日志看感觉配置的resource下都没扫到东西。最后在io.springfox与Swagger的github wiki上查了一下.</p>
<p>原来springfox提供的Swagger实现仅能作用于基于Spring MVC的REST实现，Jersey不行。。<br>想要用Swagger对Jersey生成的接口产生描述文档则需要:</p>
<ul>
<li>用Swagger-api提供的Swagger-core对Jersey的resource产生Swagger2的描述文件(类似WADL/WSDL)即swagger.json。</li>
<li>在github上下载<a href="https://github.com/swagger-api/swagger-ui/releases" target="_blank" rel="noopener">swagger-ui</a>.</li>
<li>用直接运行html或docker或nginx等运行swagger-ui。</li>
<li>调整跨域策略或让swagger-ui与Jersey在同一域下。</li>
<li>访问生成的swagger.json</li>
<li>all shit done.</li>
</ul>
<p>乍一看颇为麻烦，但其实除了要手动处理下swagger-ui以外其他也还好，都是Swagger需要的步骤无非是自己做还是springfox帮你做好了。</p>
<p>完整代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">               &lt;groupId&gt;io.swagger&lt;/groupId&gt;</span><br><span class="line">               &lt;artifactId&gt;swagger-jersey2-jaxrs&lt;/artifactId&gt;</span><br><span class="line">               &lt;version&gt;1.5.0&lt;/version&gt;</span><br><span class="line">           &lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>引入swagger依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Swagger配置。</span><br><span class="line"> *</span><br><span class="line"> * @author liuxinsi</span><br><span class="line"> * @mail akalxs@gmail.com</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Log4j2</span><br><span class="line">public class Swagger &#123;</span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void initSwagger() &#123;</span><br><span class="line">        log.debug(&quot;init Swagger &quot;);</span><br><span class="line">        BeanConfig config = new BeanConfig();</span><br><span class="line">        config.setTitle(&quot;MMS&quot;);</span><br><span class="line">        config.setDescription(&quot;my microservice seed&quot;);</span><br><span class="line">        config.setVersion(&quot;1.0.0&quot;);</span><br><span class="line">        config.setContact(&quot;liuxinsi&quot;);</span><br><span class="line">        config.setSchemes(new String[]&#123;&quot;http&quot;, &quot;https&quot;&#125;);</span><br><span class="line">        config.setBasePath(JerseyConfig.APPLICATION_PATH);</span><br><span class="line">        config.setResourcePackage(JerseyConfig.RESOURCE_PACKAGE_NAME);</span><br><span class="line">        config.setPrettyPrint(true);</span><br><span class="line">        config.setScan(true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置整个服务的相关信息以及Resource所在包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package com.lxs.mms.rs.resource;</span><br><span class="line"></span><br><span class="line">import io.swagger.jaxrs.listing.ApiListingResource;</span><br><span class="line">import io.swagger.jaxrs.listing.SwaggerSerializers;</span><br><span class="line">import org.glassfish.jersey.logging.LoggingFeature;</span><br><span class="line">import org.glassfish.jersey.server.ResourceConfig;</span><br><span class="line">import org.slf4j.bridge.SLF4JBridgeHandler;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.ws.rs.ApplicationPath;</span><br><span class="line">import java.util.logging.Level;</span><br><span class="line">import java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * jersey 相关配置。</span><br><span class="line"> *</span><br><span class="line"> * @author liuxinsi</span><br><span class="line"> * @mail akalxs@gmail.com</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@ApplicationPath(JerseyConfig.APPLICATION_PATH)</span><br><span class="line">public class JerseyConfig extends ResourceConfig &#123;</span><br><span class="line">    public static final String APPLICATION_PATH = &quot;services&quot;;</span><br><span class="line">    public static final String RESOURCE_PACKAGE_NAME = &quot;com.lxs.mms.rs.resource&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * 覆盖jersey logging 自带的jul logger</span><br><span class="line">     */</span><br><span class="line">    private static final Logger REQ_RESP_LOGGER = Logger.getLogger(&quot;payload-logger&quot;);</span><br><span class="line"></span><br><span class="line">    public JerseyConfig() &#123;</span><br><span class="line">        // 移除根日志处理器</span><br><span class="line">        SLF4JBridgeHandler.removeHandlersForRootLogger();</span><br><span class="line">        // 绑定新的处理器</span><br><span class="line">        SLF4JBridgeHandler.install();</span><br><span class="line">        // 请求 响应日志</span><br><span class="line">        REQ_RESP_LOGGER.setLevel(Level.FINE);</span><br><span class="line">        LoggingFeature lf = new LoggingFeature(REQ_RESP_LOGGER);</span><br><span class="line">        register(lf);</span><br><span class="line"></span><br><span class="line">        // 配置Swagger</span><br><span class="line">        this.register(ApiListingResource.class);</span><br><span class="line">        this.register(SwaggerSerializers.class);</span><br><span class="line"></span><br><span class="line">        packages(RESOURCE_PACKAGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册两个feature，一个用于生成api信息，一个用于编解码产生swagger.json。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package com.lxs.mms.rs.resource.user;</span><br><span class="line"></span><br><span class="line">import com.lxs.mms.rs.resource.ResourceSupport;</span><br><span class="line">import com.lxs.mms.rs.resource.bean.user.UserInfo;</span><br><span class="line">import io.swagger.annotations.Api;</span><br><span class="line">import io.swagger.annotations.ApiOperation;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.ws.rs.GET;</span><br><span class="line">import javax.ws.rs.Path;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author liuxinsi</span><br><span class="line"> * @mail akalxs@gmail.com</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Path(&quot;/user/v1&quot;)</span><br><span class="line">@Api(value = &quot;用户相关服务&quot;, produces = &quot;application/json&quot;)</span><br><span class="line">public class UserResource extends ResourceSupport &#123;</span><br><span class="line">    @ApiOperation(value = &quot;加载所有用户&quot;, notes = &quot;要分页&quot;)</span><br><span class="line">    @GET</span><br><span class="line">    @Path(&quot;/loadUsers&quot;)</span><br><span class="line">    public List&lt;UserInfo&gt; loadUsers() &#123;</span><br><span class="line">        List&lt;UserInfo&gt; userInfos = new ArrayList&lt;&gt;(10);</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            UserInfo u = new UserInfo();</span><br><span class="line">            u.setId(i + &quot;&quot;);</span><br><span class="line">            u.setName(&quot;u&quot; + i);</span><br><span class="line">            u.setPwd(&quot;&quot;);</span><br><span class="line">            u.setRegisteDate(new Date());</span><br><span class="line">            userInfos.add(u);</span><br><span class="line">        &#125;</span><br><span class="line">        return userInfos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Resource类，注意@Api注解。</p>
<p>这时可以先启动spring-boot，访问<a href="http://127.0.0.1:8888/services/swagger.json，如生成了swagger2的信息则配置都成功。" target="_blank" rel="noopener">http://127.0.0.1:8888/services/swagger.json，如生成了swagger2的信息则配置都成功。</a><br>部署swagger-ui，我是将下载到的静态资源直接部署在spring-boot的resource/static中，让swagger-ui的请求与swagger在一个域下。<br>最后重新启动spring-boot访问swagger-ui界面。</p>
<p><img src="http://liuxinsi.github.io/swagger_ui_html.png" alt><br>all shit done。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/07/03/integrate-swagger-with-jersey-springboot/" data-id="ckpl281t1000uv6ses8sdzjpf" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/07/03/integrate-swagger-with-jersey-springboot/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jersey/">Jersey</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/">Spring-Boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swagger/">Swagger</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微服务/">微服务</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-linux-ftp-server-canot-change-directory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/25/linux-ftp-server-canot-change-directory/" class="article-date">
  <time datetime="2017-06-25T09:00:31.000Z" itemprop="datePublished">2017-06-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/25/linux-ftp-server-canot-change-directory/">Linux下FTP服务搭建完成后的一些设置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天在centos下搭建里一个ftp 服务，但是使用commen-net包下的ftpclient进行连接登录时报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">private boolean connect() &#123;</span><br><span class="line">       log.debug(&quot;ftp status:&#123;&#125;/&#123;&#125;&quot;, ftpClient.isAvailable(), ftpClient.isConnected());</span><br><span class="line">       if (!ftpClient.isConnected()) &#123;</span><br><span class="line">           log.debug(&quot;ftp client 失去连接&quot;);</span><br><span class="line">           try &#123;</span><br><span class="line">               ftpClient.logout();</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               log.debug(&quot;注销异常&quot;, e);</span><br><span class="line">           &#125;</span><br><span class="line">           try &#123;</span><br><span class="line">               ftpClient.disconnect();</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               log.debug(&quot;关闭连接异常&quot;, e);</span><br><span class="line">           &#125;</span><br><span class="line">           try &#123;</span><br><span class="line">               ftpClient.connect(BDConfig.getString(&quot;fs.ftp.ip&quot;), BDConfig.getInt(&quot;fs.ftp.port&quot;));</span><br><span class="line">           &#125; catch (IOException e) &#123;</span><br><span class="line">               log.error(&quot;连接到:&#123;&#125;:&#123;&#125;异常&quot;, BDConfig.getString(&quot;fs.ftp.ip&quot;), BDConfig.getString(&quot;fs.ftp.port&quot;), e);</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           boolean connect = FTPReply.isPositiveCompletion(ftpClient.getReplyCode());</span><br><span class="line">           log.debug(&quot;ftp 连接完毕:&#123;&#125;。&quot;, connect, ftpClient.getReplyString());</span><br><span class="line"></span><br><span class="line">           if (!Strings.isEmpty(Config.getString(&quot;fs.ftp.userName&quot;)) &amp;&amp; !Strings.isEmpty(Config.getString(&quot;fs.ftp.password&quot;))) &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                   boolean b = ftpClient.login(Config.getString(&quot;fs.ftp.userName&quot;), Config.getString(&quot;fs.ftp.password&quot;));</span><br><span class="line">                   log.debug(&quot;&#123;&#125;/&#123;&#125;登录结果：&#123;&#125;/&#123;&#125;&quot;, Config.getString(&quot;fs.ftp.userName&quot;), Config.getString(&quot;fs.ftp.password&quot;), b, ftpClient.getReplyString());</span><br><span class="line">               &#125; catch (IOException e) &#123;</span><br><span class="line">                   log.error(&quot;登录到:&#123;&#125;:&#123;&#125;异常&quot;, Config.getString(&quot;fs.ftp.ip&quot;), Config.getString(&quot;fs.ftp.port&quot;), e);</span><br><span class="line">                   return false;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           try &#123;</span><br><span class="line">               ftpClient.setFileType(FTP.BINARY_FILE_TYPE);</span><br><span class="line">           &#125; catch (IOException e) &#123;</span><br><span class="line">               log.error(&quot;设置文件类型异常,&#123;&#125;&quot;, e, ftpClient.getReplyString());</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       return true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>连接没问题，登录报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftpuser2/ftpuser2登录结果：false/500 OOPS: cannot change directory:/home/ftpuser2</span><br></pre></td></tr></table></figure></p>
<p>一开始以为是用户的问题，重新配置了一下vsftpd仍然不行。<br>最后google下发现linux搭建好ftp server还要配置几个开关项才能使用。使用命令查看ftp的配置项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sestatus -b|grep ftp</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">allow_ftpd_anon_write                       off</span><br><span class="line">allow_ftpd_full_access                      off</span><br><span class="line">allow_ftpd_use_cifs                         off</span><br><span class="line">allow_ftpd_use_nfs                          off</span><br><span class="line">ftp_home_dir                                off</span><br><span class="line">ftpd_connect_db                             off</span><br><span class="line">ftpd_use_fusefs                             off</span><br><span class="line">ftpd_use_passive_mode                       off</span><br><span class="line">httpd_enable_ftp_server                     off</span><br><span class="line">tftp_anon_write                             off</span><br><span class="line">tftp_use_cifs                               off</span><br><span class="line">tftp_use_nfs                                off</span><br></pre></td></tr></table></figure>
<p>其中ftp_home_dir用于控制用户目录下的读写,如果此项是off则会报出 cannot change directory错误，使用命令开启<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setsebool -P ftp_home_dir on</span><br></pre></td></tr></table></figure></p>
<p>重启server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd restart</span><br></pre></td></tr></table></figure></p>
<p>重启完后程序可以正常连接登录。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/06/25/linux-ftp-server-canot-change-directory/" data-id="ckpl281t0000nv6sek7g6u7tj" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/06/25/linux-ftp-server-canot-change-directory/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FTPClient/">FTPClient</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FTPServer/">FTPServer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-mongodb-oom-killer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/01/mongodb-oom-killer/" class="article-date">
  <time datetime="2017-06-01T12:48:54.000Z" itemprop="datePublished">2017-06-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/01/mongodb-oom-killer/">MongoDB被Linux OOM Kill</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天无意发现线上mongodb集群中，某个mongodb连不上了，到服务器上看mongodb日志并未发现异常日志，就得过且过的想把它启起来就算了。<br>结果启动后大约1小时左右又突然消失，日志仍然没任何退出信息。。<br>这问题就大了，进程突然消失就像被kill -9了一样，但是查history记录并没人执行过。<br>于是 dmesg|grep mongo了一下果然发现问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mongod invoked oom-killer: gfp_mask=0x201da, order=0, oom_adj=0, oom_score_adj=0</span><br><span class="line">mongod cpuset=/ mems_allowed=0</span><br><span class="line">Pid: 10123, comm: mongod Not tainted 2.6.32-431.el6.x86_64 #1</span><br><span class="line">[ 3235]     0  3235  2568388   270165   6       0             0 mongod</span><br><span class="line">[10113]     0 10113  1094500   749847   0       0             0 mongod</span><br><span class="line">Out of memory: Kill process 3235 (mongod) score 252 or sacrifice child</span><br><span class="line">Killed process 3235, UID 0, (mongod) total-vm:10273552kB, anon-rss:1080440kB, file-rss:220kB</span><br><span class="line">[10113]     0 10113  1179731   454666   0       0             0 mongod</span><br><span class="line">[32534]     0 32534  1549332  1316079   3       0             0 mongod</span><br><span class="line">[32663]     0 32663   232939    37877   2       0             0 mongodump</span><br><span class="line">Out of memory: Kill process 32534 (mongod) score 184 or sacrifice child</span><br><span class="line">Killed process 32534, UID 0, (mongod) total-vm:6197328kB, anon-rss:5263596kB, file-rss:724kB</span><br></pre></td></tr></table></figure></p>
<p>与mongodb日志对比发现，被杀的pid与最后一次启动进程的pid一致，可以确认被linux oom(Out of Memory) killer杀了。<br>而触发oom killer一般是应用程序大量请求内存导致系统内存不足造成的，而为了保证整个系统的稳定linux内核会杀掉某个进程。</p>
<blockquote><p>Linux 内核根据应用程序的要求分配内存，通常来说应用程序分配了内存但是并没有实际全部使用，为了提高性能，这部分没用的内存可以留作它用，这部分内存是属于每个进程的，内核直接回收利用的话比较麻烦，所以内核采用一种过度分配内存（over-commit memory）的办法来间接利用这部分 “空闲” 的内存，提高整体内存的使用效率。一般来说这样做没有问题，但当大多数应用程序都消耗完自己的内存的时候麻烦就来了，因为这些应用程序的内存需求加起来超出了物理内存（包括 swap）的容量，内核（OOM killer）必须杀掉一些进程才能腾出空间保障系统正常运行。</p>
<footer><strong>vpsee</strong><cite><a href="http://www.vpsee.com/2013/10/how-to-configure-the-linux-oom-killer/" target="_blank" rel="noopener">理解和配置 Linux 下的 OOM Killer</a></cite></footer></blockquote>
<p>接着往上看dmesg发现这段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Node 0 DMA: 1*4kB 1*8kB 1*16kB 1*32kB 1*64kB 1*128kB 0*256kB 0*512kB 1*1024kB 1*2048kB 3*4096kB = 15612kB</span><br><span class="line">Node 0 DMA32: 505*4kB 347*8kB 230*16kB 175*32kB 122*64kB 86*128kB 48*256kB 16*512kB 8*1024kB 2*2048kB 0*4096kB = 65660kB</span><br><span class="line">Node 0 Normal: 1227*4kB 1125*8kB 827*16kB 353*32kB 145*64kB 43*128kB 4*256kB 0*512kB 0*1024kB 0*2048kB 0*4096kB = 54244kB</span><br><span class="line">7665 total pagecache pages</span><br><span class="line">5466 pages in swap cache</span><br><span class="line">Swap cache stats: add 16986448, delete 16980982, find 7091644/8157320</span><br><span class="line">Free swap  = 0kB</span><br><span class="line">Total swap = 8241144kB</span><br><span class="line">4194288 pages RAM</span><br><span class="line">110410 pages reserved</span><br><span class="line">1934 pages shared</span><br><span class="line">4043507 pages non-shared</span><br></pre></td></tr></table></figure>
<p>可以确定mongodb进程的消失是因为swap耗尽导致。而swap的耗尽又可能是因为业务的必要机制需要当新集群服务上线从而进行集中的整库的查询导致swap耗尽。</p>
<p>通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/meminfo</span><br></pre></td></tr></table></figure></p>
<p>和<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br></pre></td></tr></table></figure></p>
<p>看了下，机器硬件条件确实一般，内存和swap也所剩不多。</p>
<p>给进程按内存排个序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -e -o &apos;pid,comm,args,rsz,vsz&apos;|sort -nrk4</span><br></pre></td></tr></table></figure></p>
<p>前三甲的大户都是pid小于5k的一等公民，也不敢动，自然pid五位数又能吃内存的mongodb被选中kill。要是我也选它。</p>
<p>触发oom killer后选择哪个进程被杀，是根据内核特定的算法给每个进程打分从而决定是否被选中，分数可以在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/$pid/oom_score</span><br></pre></td></tr></table></figure></p>
<p>中看到，而设置oom_adj的值可以调整oom killer的行为，比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -17 &gt; /proc/$pid/oom_adj</span><br></pre></td></tr></table></figure></p>
<p>oom_adj的可调值为15到-16，其中15最大-16最小，-17为禁止使用oom，值越小越不容易被杀。</p>
<p>虽然问题找到，但解决起来却很纠结，oom killer虽然杀掉mongodb进程，但它也是为了保证整个系统稳定，即使调整mongodb的分数，但最终也会有一个进程被选中杀掉。如关闭oom killer当系统资源耗尽可能导致的结果就是系统无响应需要重启，并且只是将问题暂时的盖住而已，问题仍然在那不符合fast fail的理念。</p>
<p>serverfault上有个不错的oom killer实践可以参考的看看。<br><blockquote><p>OOM killer is not a way anyone manages memory; it is Linux kernels way to handle fatal failure in last hope to avoid system lockup!</p>
<p>What you should do is:</p>
<p>make sure you have enough swap. If you are sure, still add more.<br>implement resource limits! At LEAST for applications you expect that will use memory (and even more so if you don’t expect them to - those ones usually end up being problematic). See ulimit -v (or limit addressspace) commands in your shell and put it before application startup in its init script. You should also limit other stuff (like number of processes -u, etc)… That way, application will get ENOMEM error when there is not enough memory, instead of kernel giving them non-existent memory and afterwards going berserk killing everything around!<br>tell the kernel not to overcommit memory. You could do:</p>
<p>echo “0” &gt; /proc/sys/vm/overcommit_memory<br>or even better (depending on your amount of swap space)</p>
<p>echo “2” &gt; /proc/sys/vm/overcommit_memory; echo “80” &gt; /proc/sys/vm/overcommit_ratio<br>See Turning off overcommit for more info on that.</p>
<p>That would instruct kernel to be more carefull when giving applications memory it doesn’t really have (similarity to worlds global economic crisis is striking)<br>as a last dich resort, if everything on your system except MangoDB is expendable (but please fix two points above first!) you can make lower the chances of it being killed (or even making sure it won’t be killed - even if alternative is hangup machine with nothing working) by tuning /proc/$pid/oom_score_adj and/or /proc/$pid/oom_score.</p>
<p>echo “-1000” &gt; /proc/<code>pidof mangod</code>/oom_score_adj<br>See Taming the OOM killer for more info on that subject.</p>
<footer><strong>Matija Nalis</strong><cite><a href="https://serverfault.com/questions/537176/mongodb-getting-oom-killed" target="_blank" rel="noopener">MongoDB getting OOM killed</a></cite></footer></blockquote></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/06/01/mongodb-oom-killer/" data-id="ckpl281sz000lv6sejs9anubz" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/06/01/mongodb-oom-killer/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-auth-tech-4-apis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/21/auth-tech-4-apis/" class="article-date">
  <time datetime="2017-05-21T02:19:45.000Z" itemprop="datePublished">2017-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/微服务/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/21/auth-tech-4-apis/">API安全认证技术(翻译)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在网上看到的一个API安全认证技术对比表格，觉得蛮好的，方案选型时用的上，MARK并翻译一下。</p>
<p>原文来自：<a href="https://docs.google.com/spreadsheets/d/1tAX5ZJzluilhoYKjra-uHbMCZraaQkqIHl3RIQ8mVkM/htmlview?sle=true#gid=0" target="_blank" rel="noopener">Authentication Techniques for APIs</a></p>
<p>Hexo的表格渲染太烂了。。。还是看原文吧</p>
<table>
<thead>
<tr>
<th style="text-align:left">&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</th>
<th style="text-align:center">HTTP Basic Auth</th>
<th style="text-align:center">Stateless Session Cookie</th>
<th style="text-align:center">JWT</th>
<th style="text-align:center">Stateful Session Cookie</th>
<th style="text-align:center">Random Token</th>
<th style="text-align:center">Full Request Signature</th>
<th style="text-align:center">OAuth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">简介</td>
<td style="text-align:center">基础认证，需要每个请求都附带用户名与密码</td>
<td style="text-align:center">对包含用户信息的cookie进行签名或加密，通常Web框架可以处理</td>
<td style="text-align:center">对用户信息签名或加密到一个编码后的json字符串，每个语言都有经过良好测试的类库可以利用</td>
<td style="text-align:center">标准cookie，大部分web框架和浏览器支持</td>
<td style="text-align:center">一个不包含任何信息 强壮、安全的随机令牌，无法被猜测。等价于session id</td>
<td style="text-align:center">通过AWS认证普及开来的一种机制。客户端与服务端共享一个秘钥，客户端使用这个秘钥对整个请求进行签名，服务端通过这个秘钥对请求进行验证。<a href="http://docs.aws.amazon.com/general/latest/gr/sigv4_signing.html" target="_blank" rel="noopener">AWS文档</a></td>
<td style="text-align:center">当你想从第三方应用中获取你用户的信息，可以使用这种机制。如果你没有第三个应用，oauth机制则有点大材小用</td>
</tr>
<tr>
<td style="text-align:left">适用场景</td>
<td style="text-align:center">最好仅用在内网没什么价值的服务端接口认证</td>
<td style="text-align:center">如果仅仅开发一个基于web的应用，并且你的框架支持，而且你没有一个类似Redis/Memcache的分布缓存，那么可以用用，但不要自己实现(利用框架或容器)</td>
<td style="text-align:center">当你可以放弃自动过期与主动失效机制时，原生移动端，web移动端，服务端适用</td>
<td style="text-align:center">适用于可以把信息存储到数据库或分布式缓存中的web应用</td>
<td style="text-align:center">如果你有一个类似redis或memcache的分布式缓存那么web应用与移动应用适用，服务端更适合基于JWT的一次性令牌</td>
<td style="text-align:center">当你为你的客户端提供管理加解密算法的类库并且在意重放攻击的服务端应用适用。实际上，为每个请求使用JWT并且将url和关键请求参数包含到JWT中，这种方法最大的好处是不用实现复杂的标准算法</td>
<td style="text-align:center">适用于你要从外部第三方应用获取数据并且你的用户授权第三方应用提供他的数据给你的场景，如果不是，oauth有点大材小用</td>
</tr>
<tr>
<td style="text-align:left">存储机制</td>
<td style="text-align:center">用户名密码存储在服务端。用户名密码附带在每个请求上，服务端通过传递过来的用户名密码校验用户是否合法，校验通过后进行请求对应的操作</td>
<td style="text-align:center">存在cookie中</td>
<td style="text-align:center">编码后的json(令牌)中</td>
<td style="text-align:center">服务端的内存、数据库、分布式缓存或磁盘中</td>
<td style="text-align:center">服务端的内存、数据库、分布式缓存或磁盘中</td>
<td style="text-align:center">服务端，userid通过请求传递，服务器通过签名确定用户，然后从数据库中获取想要的信息</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">过期策略</td>
<td style="text-align:center">无，服务器端管理</td>
<td style="text-align:center">有，cookie控制</td>
<td style="text-align:center">有，令牌控制</td>
<td style="text-align:center">有，服务端控制</td>
<td style="text-align:center">有，服务端控制</td>
<td style="text-align:center">通过请求传递，通常仅设置一个很短的时间</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">加密机制</td>
<td style="text-align:center">无</td>
<td style="text-align:center">有，通常web框架处理</td>
<td style="text-align:center">有，有成熟的第三方类库</td>
<td style="text-align:center">无</td>
<td style="text-align:center">无</td>
<td style="text-align:center">有，但是AWS没有提供类库，可以提供一个自己的客户端类库，否则很痛苦</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">闲置过期(失效/超时)</td>
<td style="text-align:center">无，不要将此技术用于基于Web的客户端</td>
<td style="text-align:center">服务端需要为每个请求的cookie设置新的超时时间，如果web框架不支持，自己处理会很痛苦</td>
<td style="text-align:center">有很痛苦，你需要刷新客户端提供令牌，并且要在数据库或缓存中维护令牌最后一次请求时间，而且已然失去无状态的好处</td>
<td style="text-align:center">有，每个web框架都以实现</td>
<td style="text-align:center">有，每个进来的请求在服务端判断超时时间</td>
<td style="text-align:center">无意义</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">主动失效</td>
<td style="text-align:center">无，不要将此技术用于基于Web的客户端(前面直翻，其实依赖服务端)</td>
<td style="text-align:center">很痛苦，需要在一个分布式存储中维护一个撤销列表。这样已然失去无状态的好处</td>
<td style="text-align:center">很痛苦，需要在一个分布式存储中维护一个撤销列表。这样已然失去无状态的好处</td>
<td style="text-align:center">有，实际上取决于使用的web框架</td>
<td style="text-align:center">有，在服务端删除生成的令牌那么下个进来的请求将被认为未授权的请求</td>
<td style="text-align:center">有，服务端可以请求拒绝请求</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">浏览器存储</td>
<td style="text-align:center">无，不要将此技术用于基于Web的客户端</td>
<td style="text-align:center">浏览器自动存储，程序无需处理</td>
<td style="text-align:center">有，开发人员需要编码存储token。通常是sessionStorage或localStorage中</td>
<td style="text-align:center">浏览器自动存储，程序无需处理</td>
<td style="text-align:center">有，开发人员需要编码存储token。通常是sessionStorage或localStorage中</td>
<td style="text-align:center">不适用，此机制不适合web应用</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">凭证传递</td>
<td style="text-align:center">通过HTTP头 Authorization传递。<br> Example: <br>  Authorization: Basic QWxhZGRpbjpPcGVuU2VzYW1l 用户名密码没有被加密</td>
<td style="text-align:center">通过cookie传递，浏览器自动发送到服务器</td>
<td style="text-align:center">通过请求头Authorization: Bearer &lt;token>传递，开发人员需要编码为每个请求添加</td>
<td style="text-align:center">通过cookie传递，浏览器自动发送到服务器</td>
<td style="text-align:center">通过请求头Authorization: Bearer &lt;token>传递，开发人员需要编码为每个请求添加</td>
<td style="text-align:center">通过请求头Authorization传递，但是适用自定义的schema替换了”bearer”。开发人员需要编码为每个请求添加</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">CSRF预防</td>
<td style="text-align:center">非常脆弱，不要用在基于Web应用，除非是非常没价值的内网web应用</td>
<td style="text-align:center">非常脆弱，开发者需要自己预防跨站脚本攻击</td>
<td style="text-align:center">可以预防，请求头中包含token</td>
<td style="text-align:center">非常脆弱，开发者需要自己预防跨站脚本攻击</td>
<td style="text-align:center">可以预防，请求头中包含token</td>
<td style="text-align:center">不适用，此机制不适合web应用</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">移动端适用</td>
<td style="text-align:center">不要使用，web应用无法安全的存储凭证，同时用户也不会想手动的为每个请求输入凭证</td>
<td style="text-align:center">原生移动端会很痛苦，避免为原生移动端基于session认证的api</td>
<td style="text-align:center">移动端用户期望只需登录一次，JWT通过设置一个长的失效时间可以实现，但是更好的策略是用一个不存储任何信息的安全随机令牌</td>
<td style="text-align:center">原生移动端会很痛苦，避免为原生移动端基于session认证的api</td>
<td style="text-align:center">在第一次登录的时候创建一个随机令牌，在app的整个生命周期中使用它</td>
<td style="text-align:center">不适用，此机制不适用web应用</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">服务端适用</td>
<td style="text-align:center">如果服务端应用(内网相互调用的服务)基于HTTPS，基础认证也许是个不错(方便)的选择。基础认证使用非常简单，客户端与服务端框架的支持非常好</td>
<td style="text-align:center">服务端应用会很痛苦，避免为服务端提供基于session认证的api</td>
<td style="text-align:center">创建一个公私秘钥对，然后让客户端使用私钥生成JWT，服务端通过公钥进行验证。也可以维护一个共享的口令来创建JWT。当然公私秘钥对最佳。为每个请求创建JWT，同时设置一个很短的过期时间</td>
<td style="text-align:center">服务端应用会很痛苦，避免为服务端提供基于session认证的api</td>
<td style="text-align:center">类似客户端传递api key，不过如果其他人获取了api key有可能造成重放攻击。服务端最好使用JWT公私秘钥对</td>
<td style="text-align:center">如果服务端需要更高的安全性这是首选，原则上类似JWT共享秘钥，但在此机制下所有的东西都会被签名：url、请求参数、请求头、请求体</td>
<td style="text-align:center">TBD</td>
</tr>
<tr>
<td style="text-align:left">重放攻击预防</td>
<td style="text-align:center">绝对有可能</td>
<td style="text-align:center">有可能</td>
<td style="text-align:center">如果过期时间很长，那很有可能，如果每个请求的JWT只用一次那么重放会变的很难</td>
<td style="text-align:center">有可能</td>
<td style="text-align:center">有可能</td>
<td style="text-align:center">所有东西都被签名了，不可能重放</td>
<td style="text-align:center">TBD</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/05/21/auth-tech-4-apis/" data-id="ckpl281se0002v6se7epml5t8" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/05/21/auth-tech-4-apis/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cheetsheet/">Cheetsheet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microservices/">Microservices</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RESTful-Api/">RESTful Api</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/安全认证技术/">安全认证技术</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-jersey-gzipencoder" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/12/jersey-gzipencoder/" class="article-date">
  <time datetime="2017-05-12T02:08:36.000Z" itemprop="datePublished">2017-05-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/微服务/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/12/jersey-gzipencoder/">Jersey开启Gzip踩的坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近给一个基于Jerysey的Restful项目增加gzip功能，通过自动代码提示发现Jersey自带了一个GZipEncoder，通过注释看，只要头CONTENT_ENCODING为gzip或x-gzip就可以进行压缩和解压。<br>于是在ResourceConfig里直接注册了GzipEncoder。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register(GzipEncoder.class);</span><br></pre></td></tr></table></figure>
<p>但在测试的时候发现，请求压缩后decode没问题，但返回的响应则无法encode，也就是无法压缩，一开始以为是ACCEPT_ENCODING问题，但设置了也不对，最后debug发现根本进不去GzipEncoder#encode方法。<br>测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">CloseableHttpClient client = HttpClients.createDefault();</span><br><span class="line">StringEntity entity = new StringEntity(&quot;&#123;\&quot;id\&quot;:\&quot;123\&quot;&#125;&quot;, ContentType.create(</span><br><span class="line">        ContentType.APPLICATION_JSON.getMimeType(), &quot;UTF-8&quot;));</span><br><span class="line">entity.setContentEncoding(&quot;UTF-8&quot;);</span><br><span class="line">GzipCompressingEntity gc=new GzipCompressingEntity(entity);</span><br><span class="line"></span><br><span class="line">String out = null;</span><br><span class="line">try &#123;</span><br><span class="line">    // send</span><br><span class="line">    HttpPost post = new HttpPost(&quot;http://127.0.0.1:8080/services/test/v1/x&quot;);</span><br><span class="line">    try &#123;</span><br><span class="line">        post.addHeader(&quot;Accept-Encoding&quot;,&quot;gzip&quot;);</span><br><span class="line">        post.setEntity(gc);</span><br><span class="line">        CloseableHttpResponse response = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            response = client.execute(post);</span><br><span class="line">            int code = response.getStatusLine().getStatusCode();</span><br><span class="line">            if (code != HttpStatus.SC_OK) &#123;</span><br><span class="line">                throw new BizSystemException(&quot;发送请求失败，返回的状态码：&quot; + code);</span><br><span class="line">            &#125;</span><br><span class="line">            HttpEntity respEntity = response.getEntity();</span><br><span class="line"></span><br><span class="line">            // consume</span><br><span class="line">            out = EntityUtils.toString(respEntity, &quot;UTF-8&quot;);</span><br><span class="line">            EntityUtils.consume(respEntity);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;发送请求异常&quot;, e);</span><br><span class="line">            throw new BizSystemException(&quot;发送请求失败&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            IOUtils.closeQuietly(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        post.releaseConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    IOUtils.closeQuietly(client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后google了一下发现启用GzipEncoder压缩响应属于entity-filtering，需要开启entity-filtering，于是引入类库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.glassfish.jersey.ext&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jersey-entity-filtering&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.21&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>并且开启entity-filtering功能，以及激活gzipencoder：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">register(EntityFilteringFeature.class);</span><br><span class="line">EncodingFilter.enableFor(this, GZipEncoder.class);</span><br></pre></td></tr></table></figure></p>
<p>通过日志看已经可以正确处理请求和响应的压缩。<br>使用时还需要注意的时GZipEncoder的优先级为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Priority(Priorities.ENTITY_CODER)</span><br><span class="line">public class GZipEncoder extends ContentEncoder&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是4000，如果有自定义的过滤器/拦截器需要注意下顺序。</p>
<p>比较坑的是看源码GZIPEncoder仅仅是一个拦截器，按照以往的经验注册一下调整下顺序就应该是开箱即用的，为毛会和Entity-Filtering扯上关系，还要多引一个依赖，根据官网Entity-Filtering的介绍来看：</p>
<blockquote>
<p>Support for Entity Filtering in Jersey introduces a convenient facility for reducing the amount of data exchanged over the wire between client and server without a need to create specialized data view components. The main idea behind this feature is to give you APIs that will let you to selectively filter out any non-relevant data from the marshalled object model before sending the data to the other party based on the context of the particular message exchange. This way, only the necessary or relevant portion of the data is transferred over the network with each client request or server response, without a need to create special facade models for transferring these limited subsets of the model data.</p>
</blockquote>
<p>Entity-Filtering功能最大的作用就是减少传输间的显示组件(view components)，也就是说往往在客户端与服务器端的数据交换都需要定义很多JavaBean用来序列化请求/响应，哪怕有很多无关的数据需要组合到一起都要定义一个根的JavaBean用于组合它们(Facade模式)。</p>
<p>Entity-Filtering可以在传输的时候对数据进行处理，避免创建这些Facade对象。</p>
<p>所以究竟为啥一个拦截器的工作需要和Entity-Filtering有关联呢。😂</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p>1.<a href="http://www.codingpedia.org/ama/how-to-compress-responses-in-java-rest-api-with-gzip-and-jersey/" target="_blank" rel="noopener">how-to-compress-responses-in-java-rest-api-with-gzip-and-jersey</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/05/12/jersey-gzipencoder/" data-id="ckpl281sq000bv6see8sf0o06" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/05/12/jersey-gzipencoder/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jersey/">Jersey</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microservices/">Microservices</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RESTful-Api/">RESTful Api</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/踩坑/">踩坑</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-tcp-optimize" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/07/tcp-optimize/" class="article-date">
  <time datetime="2017-05-07T11:55:30.000Z" itemprop="datePublished">2017-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/07/tcp-optimize/">TCP优化--减少TIME_WAIT提高吞吐</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近期做压力测试的时候发现有很多TIME_WAIT,虽然程序吞吐达标，不过还是想进一步的优化下。<br>由于一台服务器建立的连接数是有限的，也就65535，外加一些不能用的，比如0-1024和其他程序占的。<br>可以使用命令查看当前服务器可以使用的端口范围，比如目前这台CentOS 6.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br><span class="line"></span><br><span class="line">LSB Version:	:base-4.0-amd64:base-4.0-noarch:core-4.0-amd64:core-4.0-noarch:graphics-4.0-amd64:graphics-4.0-noarch:printing-4.0-amd64:printing-4.0-noarch</span><br><span class="line">Distributor ID:	CentOS</span><br><span class="line">Description:	CentOS release 6.5 (Final)</span><br><span class="line">Release:	6.5</span><br><span class="line">Codename:	Final</span><br></pre></td></tr></table></figure>
<p>使用命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/net/ipv4/ip_local_port_range</span><br></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">32768	61000</span><br></pre></td></tr></table></figure></p>
<p>代表当前服务器可用端口数为61000-32768=28232，也就是说理论上最多建立的连接就是28232。</p>
<p>在做压力测试的时候，通过命令统计TIME_WAIE的数量为2w+<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an |grep TIME_WAIT|wc -l</span><br></pre></td></tr></table></figure></p>
<p>使用命令增大端口范围<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;5000 65535&quot;&gt;/proc/sys/net/ipv4/ip_local_port_range</span><br></pre></td></tr></table></figure></p>
<p>再次做压力测试时候TIME_WAIT的数量下降的80+。<br>除了调大端口范围，还可以设置SO_REUSEADDR、TCP连接复用进一步优化。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/05/07/tcp-optimize/" data-id="ckpl281t9001mv6se638f8jnn" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/05/07/tcp-optimize/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SOCKET/">SOCKET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TCP/">TCP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/优化/">优化</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  
    <article id="post-api-gateway-kong" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/30/api-gateway-kong/" class="article-date">
  <time datetime="2017-03-30T13:10:42.000Z" itemprop="datePublished">2017-03-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/微服务/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/30/api-gateway-kong/">可靠的Api网关--KONG(序)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://codeandcoffee.cn/2017/03/30/api-gateway-kong/" data-id="ckpl281sx000hv6se8sgmpbvc" class="article-share-link">Share</a>
      
        <a href="https://codeandcoffee.cn/2017/03/30/api-gateway-kong/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KONG/">KONG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microservices/">Microservices</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RESTful-Api/">RESTful Api</a></li></ul>

    </footer>
  </div>
  
</article>
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  this.page.url = undefined;
  this.page.identifier = undefined; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://liuxinsi.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                  

  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/业务/">业务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计/">设计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/踩坑/">踩坑</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bug/">Bug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cheetsheet/">Cheetsheet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FTPClient/">FTPClient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FTPServer/">FTPServer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FileLock/">FileLock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gson/">Gson</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jersey/">Jersey</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KONG/">KONG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kryo/">Kryo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microservices/">Microservices</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Morphia/">Morphia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFS/">NFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nacos/">Nacos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenSSH/">OpenSSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RESTful-Api/">RESTful Api</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SOCKET/">SOCKET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/">Spring-Boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger/">Swagger</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ramfs/">ramfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/业务/">业务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优化/">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/安全传输/">安全传输</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/安全认证技术/">安全认证技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计/">设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/踩坑/">踩坑</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Ansible/" style="font-size: 10px;">Ansible</a> <a href="/tags/Bug/" style="font-size: 10px;">Bug</a> <a href="/tags/Cheetsheet/" style="font-size: 10px;">Cheetsheet</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/FTPClient/" style="font-size: 10px;">FTPClient</a> <a href="/tags/FTPServer/" style="font-size: 10px;">FTPServer</a> <a href="/tags/FileLock/" style="font-size: 10px;">FileLock</a> <a href="/tags/Gson/" style="font-size: 10px;">Gson</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Jersey/" style="font-size: 12.5px;">Jersey</a> <a href="/tags/KONG/" style="font-size: 10px;">KONG</a> <a href="/tags/Kryo/" style="font-size: 10px;">Kryo</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/Microservices/" style="font-size: 15px;">Microservices</a> <a href="/tags/MongoDB/" style="font-size: 17.5px;">MongoDB</a> <a href="/tags/Morphia/" style="font-size: 12.5px;">Morphia</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nacos/" style="font-size: 10px;">Nacos</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/OpenSSH/" style="font-size: 10px;">OpenSSH</a> <a href="/tags/RESTful-Api/" style="font-size: 17.5px;">RESTful Api</a> <a href="/tags/SOCKET/" style="font-size: 10px;">SOCKET</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring-Boot</a> <a href="/tags/Swagger/" style="font-size: 10px;">Swagger</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/ramfs/" style="font-size: 10px;">ramfs</a> <a href="/tags/业务/" style="font-size: 10px;">业务</a> <a href="/tags/优化/" style="font-size: 10px;">优化</a> <a href="/tags/安全传输/" style="font-size: 10px;">安全传输</a> <a href="/tags/安全认证技术/" style="font-size: 12.5px;">安全认证技术</a> <a href="/tags/微服务/" style="font-size: 12.5px;">微服务</a> <a href="/tags/设计/" style="font-size: 10px;">设计</a> <a href="/tags/踩坑/" style="font-size: 20px;">踩坑</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/07/nacos-ephemeral/">Nacos临时节点和永久节点的本质意义</a>
          </li>
        
          <li>
            <a href="/2019/03/11/design-for-abnormal-payment/">奇葩的异常支付场景</a>
          </li>
        
          <li>
            <a href="/2019/01/21/macvim-spacevim-characters-illegible-contents/">MacVim使用SpaceVim后中文乱码</a>
          </li>
        
          <li>
            <a href="/2018/12/01/secure-data-transmission-plan/">相对安全的网络传输方案</a>
          </li>
        
          <li>
            <a href="/2018/10/21/java-file-lock-on-linux/">在Linux下正确的使用Java锁</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Liu Xin Si<br>
      Powered by <a href="http://hexo.io/" rel='external nofollow' target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'liuxinsi';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>